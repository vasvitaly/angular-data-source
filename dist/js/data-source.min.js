"use strict";angular.module("vasvitaly.angular-data-source",[]).factory("vvvDataSource",["$filter","$injector",function($filter,$injector){var DataSource,DEFAULTS={perPage:20};return DataSource=function(modelClass,options){var self,initialFilter,newItemDefaults,baseOptions,callBack,filterOnServer,sorting,pagination;if(self=this,null==options&&(options={}),null==modelClass)throw new TypeError("modelClass should be angular resource like class");if(!modelClass.query||!angular.isFunction(modelClass.query))throw new TypeError("modelClass should have query method");initialFilter=options.clearFilter||{},newItemDefaults=options.newItemDefaults||{},baseOptions={},callBack=null,filterOnServer=!1,self.filter=options.filter||{},self.messages={error:[],success:[]},self.inProgress=!1,sorting=angular.extend({fieldId:"",desc:!1},options.sorting||{}),pagination={perPage:options.perPage&&options.perPage>0?options.perPage:DEFAULTS.perPage,page:options.page&&options.page>-1?options.page:1};var doQuery=function(){var options={};return angular.copy(baseOptions,options),getOptions(options),self.inProgress=!0,self.rows=modelClass.query(options,function(results){var pinfo;return results&&results.length&&results[results.length-1].pagination&&(pinfo=results.pop().pagination,angular.copy(pinfo,pagination)),filterOnServer||(filterOnServer=isFiltered()||isServerPaginated()),callBack&&callBack(results),self.inProgress=!1,results}),self.rows},getOptions=function(options){return isPaginated()&&(options.page=pagination.page,options.perPage=pagination.perPage),isSorted()&&(options.sortby=sorting.fieldId,options.desc=sorting.desc),isFiltered()&&(options.filter=getFilters()),options},isPaginated=function(){return pagination.page>1||!self.rows||!self.rows.length?!0:pagination.totalCount&&pagination.perPage&&pagination.page?maxPage()>1:!1},maxPage=function(){return Math.ceil(pagination.totalCount/pagination.perPage)},isServerPaginated=function(){return!pagination.locally&&isPaginated()},isSorted=function(){return sorting&&sorting.fieldId&&sorting.fieldId>""},isFiltered=function(){var key,value;for(key in self.filter)if(value=self.filter[key],void 0!==value&&""!==value)return!0;return!1},getFilters=function(){return getNotEmpty(self.filter)},getNotEmpty=function(obj){var key,value,res,fname;if(res=null,!angular.isObject(obj))return obj;for(key in obj)value=getNotEmpty(obj[key]),void 0!=value&&null!=value&&""!==value&&(fname=key,0==fname.indexOf("__")&&(fname=fname.replace(/^__/,"")),null==res&&(res={}),res[fname]=value);return res},prepareFilters=function(filter){var filters,key,val,fname;filters={filter:{}};for(key in filter)val=filter[key],0==key.indexOf("__")?(fname=key.replace(/^__/,""),filters[fname]=val):filters.filter[key]=val;return filters},getPaged=function(data){var begin;return pagination.totalCount&&pagination.totalCount==data.length||(pagination.totalCount=data.length,pagination.page=1),null==pagination.perPage&&(pagination.perPage=DEFAULTS.perPage),null==pagination.page&&(pagination.page=1),pagination.locally=!0,begin=(pagination.page-1)*pagination.perPage,$filter("limitTo")(data,pagination.perPage,begin)},pushMessage=function(eventType,message){self.messages[eventType]||(self.messages[eventType]=[]),self.messages[eventType].push(message)},applyErrors=function(row,response){response&&response.data&&(response.data.errors&&angular.forEach(response.data.errors,function(errors,field){var message=errors;angular.isArray(message)&&(message=message.join("\n")),pushMessage("error",[field,message])}),response.data.error_fields&&(row.errors=response.data.error_fields))};return self.query=function(opts,callBackFunc){return baseOptions=opts,callBack=callBackFunc,self.rows=doQuery(),self.rows},self.paginate=function(page){return(!page||1>page)&&(page=1),maxPage()&&page>maxPage()&&(page=maxPage()),pagination.page==page?!1:(pagination.page=page,isServerPaginated()&&doQuery(),!0)},self.sortBy=function(fieldId){return sorting.fieldId===fieldId?sorting.desc=!sorting.desc:(sorting.fieldId=fieldId,sorting.desc=!1),pagination.page=1,filterOnServer&&doQuery(),!0},self.paginationInfo=function(){return pagination},self.sortingInfo=function(){return sorting},self.isOrderedByField=function(fieldId){return sorting.fieldId===fieldId},self.applyFilter=function(forceOnServer){return"undefined"==typeof forceOnServer&&(forceOnServer=!1),filterOnServer||forceOnServer?(pagination.page=1,doQuery(),!0):!1},self.clearFilter=function(){return angular.copy(initialFilter,self.filter),self.applyFilter()},self.filteredRows=function(){var filters,res,filterName,filterData;filters=prepareFilters(self.filter),res=self.rows;for(filterName in filters)filterData=filters[filterName],$injector.has(filterName+"Filter")&&filterData&&(res=$filter(filterName)(res,filterData));return sorting&&sorting.fieldId&&(res=$filter("orderBy")(res,sorting.fieldId,sorting.desc)),(pagination.locally||!pagination.perPage||res.length>pagination.perPage)&&(res=getPaged(res)),res},self.newRecord=function(attrs){var data;return data={},angular.copy(newItemDefaults,data),angular.isObject(attrs)&&angular.extend(data,attrs),new modelClass(data)},self.save=function(row,addToTheList,successCallBack,errorsCallBack){row.id?row.$save({},function(){return delete row.saving,pushMessage("success","updated"),successCallBack&&angular.isFunction(successCallBack)&&successCallBack(row),!1},function(response){return delete row.saving,applyErrors(row,response),errorsCallBack&&angular.isFunction(errorsCallBack)&&errorsCallBack(row,response),!1}):row.$create({},function(){return delete row.saving,addToTheList&&self.add(row),pushMessage("success","added"),successCallBack&&angular.isFunction(successCallBack)&&successCallBack(row),!1},function(response){return delete row.saving,applyErrors(row,response),errorsCallBack&&angular.isFunction(errorsCallBack)&&errorsCallBack(row,response),!1}),row.saving=!0},self.add=function(row){return self.rows.unshift(row)},self.remove=function(id,removeOnServer){return angular.forEach(self.rows,function(row,idx){if(row.id===id){if(!removeOnServer)return self.rows.splice(idx,1);row.$remove({},function(){self.rows.splice(idx,1)},function(response){return response&&(404==response.status?pushMessage("error","404"):500==response.status?pushMessage("error","500"):response.data&&response.data.errors?angular.forEach(response.data.errors,function(errors){var message=errors;angular.isArray(errors)&&(message=errors.join("\n")),pushMessage("error",message)}):pushMessage("error","Server is down. Sorry.")),!1})}}),!1},self}}]);