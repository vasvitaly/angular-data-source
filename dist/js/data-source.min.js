"use strict";angular.module("vasvitaly.angular-data-source",[]).factory("vvvDataSource",["$filter","$injector",function($filter,$injector){var DataSource,DEFAULTS={perPage:20};return DataSource=function(modelClass,options){var self,initialFilter,newItemDefaults,baseOptions,callBack,filterOnServer,sorting,pagination;if(self=this,null==options&&(options={}),null==modelClass)throw new TypeError("modelClass should be angular resource like class");if(!modelClass.query||!angular.isFunction(modelClass.query))throw new TypeError("modelClass should have query method");initialFilter=options.clearFilter||{},newItemDefaults=options.newItemDefaults||{},baseOptions={},callBack=null,filterOnServer=!1,self.filter=options.filter||{},sorting=angular.extend({fieldId:"",desc:!1},options.sorting||{}),pagination={perPage:options.perPage&&options.perPage>0?options.perPage:DEFAULTS.perPage,page:options.page&&options.page>-1?options.page:1};var doQuery=function(){var options={};return angular.copy(baseOptions,options),getOptions(options),self.rows=modelClass.query(options,function(results){var pinfo;return results&&results.length&&results[results.length-1].pagination&&(pinfo=results.pop().pagination,angular.copy(pinfo,pagination)),filterOnServer||(filterOnServer=isFiltered()||isServerPaginated()),callBack&&callBack(results),results}),self.rows},getOptions=function(options){return isPaginated()&&(options.page=pagination.page),isSorted()&&(options.sortby=sorting.fieldId,options.desc=sorting.desc),isFiltered()&&(options.filter=getFilters()),options},isPaginated=function(){var maxPage;return pagination.totalCount&&pagination.perPage&&pagination.page?(maxPage=Math.ceil(pagination.totalCount/pagination.perPage),maxPage>1):!1},isServerPaginated=function(){return!pagination.locally&&isPaginated()},isSorted=function(){return sorting&&sorting.fieldId&&sorting.fieldId>""},isFiltered=function(){var key,value;for(key in self.filter)if(value=self.filter[key],void 0!==value&&""!==value)return!0;return!1},getFilters=function(){return getNotEmpty(self.filter)},getNotEmpty=function(obj){var key,value,res,fname;if(res=null,!angular.isObject(obj))return obj;for(key in obj)value=getNotEmpty(obj[key]),void 0!=value&&null!=value&&""!==value&&(fname=key,0==fname.indexOf("__")&&(fname=fname.replace(/^__/,"")),null==res&&(res={}),res[fname]=value);return res},prepareFilters=function(filter){var filters,key,val,fname;filters={filter:{}};for(key in filter)val=filter[key],0==key.indexOf("__")?(fname=key.replace(/^__/,""),filters[fname]=val):filters.filter[key]=val;return filters},getPaged=function(data){var begin;return pagination.totalCount=data.length,null==pagination.perPage&&(pagination.perPage=DEFAULTS.perPage),null==pagination.page&&(pagination.page=1),pagination.locally=!0,begin=(pagination.page-1)*pagination.perPage,$filter("limitTo")(data,pagination.perPage,begin)};return self.query=function(opts,callBackFunc){return baseOptions=opts,callBack=callBackFunc,self.rows=doQuery(),self.rows},self.paginate=function(page){return pagination.page==page?!1:(pagination.page=page,isServerPaginated()&&doQuery(),!0)},self.paginationInfo=function(){return pagination},self.sortingInfo=function(){return sorting},self.sortBy=function(fieldId){return sorting.fieldId===fieldId?sorting.desc=!sorting.desc:(sorting.fieldId=fieldId,sorting.desc=!1),pagination.page=1,filterOnServer&&doQuery(),!0},self.isOrderedByField=function(fieldId){return sorting.fieldId===fieldId},self.applyFilter=function(){return filterOnServer?(pagination.page=1,doQuery(),!0):!1},self.clearFilter=function(){return angular.copy(initialFilter,self.filter),self.applyFilter()},self.filteredRows=function(){var filters,res,filterName,filterData;filters=prepareFilters(self.filter),res=self.rows;for(filterName in filters)filterData=filters[filterName],$injector.has(filterName+"Filter")&&filterData&&(res=$filter(filterName)(res,filterData));return sorting&&sorting.fieldId&&(res=$filter("orderBy")(res,sorting.fieldId,sorting.desc)),(pagination.locally||!pagination.perPage||res.length>pagination.perPage)&&(res=getPaged(res)),res},self.newRecord=function(attrs){var data;return data={},angular.copy(newItemDefaults,data),angular.isObject(attrs)&&angular.extend(data,attrs),new modelClass(data)},self.add=function(row){return self.rows.unshift(row)},self.remove=function(id){return angular.forEach(self.rows,function(row,idx){return row.id===id?self.rows.splice(idx,1):void 0})},self}}]);